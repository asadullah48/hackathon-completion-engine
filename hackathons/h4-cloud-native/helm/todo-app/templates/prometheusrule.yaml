{{- if .Values.monitoring.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "todo-app.fullname" . }}-alerts
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    prometheus: kube-prometheus
spec:
  groups:
    - name: todo-app.rules
      rules:
        - alert: TodoAppBackendDown
          expr: up{job="{{ include "todo-app.fullname" . }}-backend"} == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "Todo App Backend is down"
            description: "Backend pod {{ "{{" }} $labels.pod {{ "}}" }} has been down for more than 1 minute."

        - alert: TodoAppHighCPU
          expr: |
            (sum(rate(container_cpu_usage_seconds_total{namespace="todo-app", container!=""}[5m])) by (pod)
            / sum(kube_pod_container_resource_limits{namespace="todo-app", resource="cpu"}) by (pod)) > 0.8
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage detected"
            description: "Pod {{ "{{" }} $labels.pod {{ "}}" }} is using more than 80% CPU."

        - alert: TodoAppHighMemory
          expr: |
            (sum(container_memory_working_set_bytes{namespace="todo-app", container!=""}) by (pod)
            / sum(kube_pod_container_resource_limits{namespace="todo-app", resource="memory"}) by (pod)) > 0.8
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage detected"
            description: "Pod {{ "{{" }} $labels.pod {{ "}}" }} is using more than 80% memory."

        - alert: TodoAppPodRestarting
          expr: increase(kube_pod_container_status_restarts_total{namespace="todo-app"}[1h]) > 3
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod restarting frequently"
            description: "Pod {{ "{{" }} $labels.pod {{ "}}" }} has restarted more than 3 times in the last hour."
{{- end }}
